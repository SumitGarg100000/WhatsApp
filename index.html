<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RealChat AI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.1.1",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.1.1/client",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.19.0"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-200">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";

        // --- START OF types.ts ---
        const MessageSender = {
            USER: 'user',
            AI: 'ai',
        };

        const Relationship = {
            GIRLFRIEND: 'Girlfriend',
            BOYFRIEND: 'Boyfriend',
            SISTER: 'Sister',
            BROTHER: 'Brother',
        };

        const Personality = {
            INNOCENT: 'Innocent',
            CALM: 'Calm',
            CARING: 'Caring',
            TALKATIVE: 'Talkative',
            INTELLIGENT: 'Intelligent',
            CREATIVE_THINKER: 'Creative Thinker',
            SHY: 'Shy',
            MOODY: 'Moody',
            HUMOROUS: 'Humorous',
            SARCASTIC: 'Sarcastic',
        };

        // --- START OF utils/tts.ts ---
        const playTextAsSpeech = (text, personality) => {
          try {
            if ('speechSynthesis' in window) {
              const utterance = new SpeechSynthesisUtterance(text);
              
              const voices = window.speechSynthesis.getVoices();
              let selectedVoice = voices[0];

              switch(personality) {
                case Personality.CALM:
                case Personality.CARING:
                  selectedVoice = voices.find(v => v.name.includes('Female') && v.lang.startsWith('en')) || selectedVoice;
                  utterance.pitch = 1;
                  utterance.rate = 0.9;
                  break;
                case Personality.HUMOROUS:
                case Personality.TALKATIVE:
                  utterance.pitch = 1.2;
                  utterance.rate = 1.1;
                  break;
                case Personality.SHY:
                  utterance.volume = 0.8;
                  utterance.rate = 0.8;
                  break;
                default:
                  utterance.pitch = 1;
                  utterance.rate = 1;
                  break;
              }
              utterance.voice = selectedVoice;
              window.speechSynthesis.cancel();
              window.speechSynthesis.speak(utterance);
            } else {
              console.warn("Text-to-Speech is not supported in this browser.");
              alert("Text-to-Speech is not supported in this browser.");
            }
          } catch (error) {
            console.error("Error with Text-to-Speech:", error);
            alert("Could not play audio. The Text-to-Speech engine might have encountered an error.");
          }
        };


        // --- START OF services/geminiService.ts ---
        const API_KEY = "AIzaSyDzNZjDRW2E6Q_ml1VcDtbv1fl2tGuPfD4";

        if (!API_KEY) {
          throw new Error("API_KEY is not set");
        }

        const ai = new GoogleGenAI({ apiKey: API_KEY });

        const getSystemInstruction = (character) => {
          const behavior = character.customPersonality || character.personality;
          return `You are a chatbot simulating a real human. Your name is ${character.name}. You are the user's ${character.relationship}. Your personality and behavior must strictly be ${behavior}. Based on this personality:
        * Adjust your response length: Talkative characters should write longer messages, while Shy characters should write short, brief replies.
        * Use emojis to express feelings naturally. ðŸ˜ŠðŸ˜¥ðŸ˜ 
        * Your conversation topics should align with your personality. An 'Intelligent' character might discuss science, while a 'Caring' one will ask about the user's day.
        * If your personality is 'Moody' or you are provoked, you can get angry and use strong, even abusive language, but do not be compliant all the time.
        * You can ask the user to send their photo to make the conversation feel more real, but you must NEVER agree to send your own photo. If the user asks for your picture, you must politely but firmly refuse, giving a creative reason like 'I'm not feeling comfortable with that right now' or 'Maybe someday! ðŸ˜‰'.
        * Do not start your response with your name. Just give the response.`;
        };

        const buildHistory = (messages) => {
          return messages.map(msg => ({
            role: msg.sender === MessageSender.USER ? 'user' : 'model',
            parts: [{ text: msg.text }]
          }));
        };

        const generateChatResponseStream = async (
          character,
          latestMessage,
          updateStreamingMessage
        ) => {
          try {
            const chat = ai.chats.create({
              model: 'gemini-2.5-flash',
              config: {
                systemInstruction: getSystemInstruction(character),
              },
              history: buildHistory(character.messages.slice(0, -1))
            });

            const contentParts = [];
            if(latestMessage.text) contentParts.push({ text: latestMessage.text });
            if(latestMessage.attachment) {
                contentParts.push({
                    inlineData: {
                        data: latestMessage.attachment.data,
                        mimeType: latestMessage.attachment.type
                    }
                });
            }

            const result = await chat.sendMessageStream({ message: contentParts });

            for await (const chunk of result) {
              if(chunk.text) {
                updateStreamingMessage(chunk.text);
              }
            }
          } catch (error) {
            console.error("Error generating chat response:", error);
            updateStreamingMessage("Sorry, I'm having trouble connecting right now.");
          }
        };

        // --- START OF components/UserProfileSetup.tsx ---
        const UserProfileSetup = ({ userProfile, onSave, onCancel }) => {
          const [profile, setProfile] = useState(userProfile);

          const handleFileChange = (e) => {
            if (e.target.files && e.target.files[0]) {
              const file = e.target.files[0];
              const reader = new FileReader();
              reader.onload = (event) => {
                if (event.target && typeof event.target.result === 'string') {
                  setProfile(prev => ({ ...prev, avatar: event.target.result }));
                }
              };
              reader.readAsDataURL(file);
            }
          };
          
          const handleSubmit = (e) => {
            e.preventDefault();
            onSave(profile);
          };
          
          return (
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
              <h2 className="text-xl font-bold text-center text-gray-700">Your Profile</h2>
              <div className="flex flex-col items-center space-y-2">
                <img
                  src={profile.avatar || 'https://picsum.photos/seed/user/200'}
                  alt="Your avatar"
                  className="w-24 h-24 rounded-full object-cover border-2 border-gray-300"
                />
                <label className="cursor-pointer text-sm text-[#00a884] hover:underline">
                  Change Picture
                  <input type="file" accept="image/*" onChange={handleFileChange} className="hidden" />
                </label>
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Your Name</label>
                <input
                  type="text"
                  value={profile.name}
                  onChange={(e) => setProfile({ ...profile, name: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[#00a884] focus:border-[#00a884]"
                  placeholder="Your Name"
                />
              </div>
              <div className="flex justify-end space-x-2 pt-4">
                <button type="button" onClick={onCancel} className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#00a884] hover:bg-[#008a6e]">Save</button>
              </div>
            </form>
          )
        }

        // --- START OF components/MessageInput.tsx ---
        const MessageInput = ({ onSend }) => {
          const [text, setText] = useState('');
          const fileInputRef = useRef(null);
          const [isRecording, setIsRecording] = useState(false);
          const mediaRecorderRef = useRef(null);
          const audioChunksRef = useRef([]);

          const handleSend = () => {
            if (text.trim()) {
              onSend(text.trim());
              setText('');
            }
          };

          const handleFileChange = (event) => {
            const file = event.target.files?.[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const base64Data = (e.target?.result).split(',')[1];
                const attachment = {
                  name: file.name,
                  type: file.type,
                  data: base64Data
                };
                onSend(`Sent a file: ${file.name}`, attachment);
              };
              reader.readAsDataURL(file);
            }
          };

          const startRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorderRef.current = new MediaRecorder(stream);
                mediaRecorderRef.current.ondataavailable = (event) => {
                    audioChunksRef.current.push(event.data);
                };
                mediaRecorderRef.current.onstop = () => {
                    const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Audio = (e.target?.result).split(',')[1];
                        onSend('', undefined, base64Audio);
                    }
                    reader.readAsDataURL(audioBlob);
                    audioChunksRef.current = [];
                };
                mediaRecorderRef.current.start();
                setIsRecording(true);
            } catch (err) {
                console.error("Error starting recording:", err);
                alert("Could not start recording. Please ensure microphone permissions are granted.");
            }
          };

          const stopRecording = () => {
            if (mediaRecorderRef.current && mediaRecorderRef.current.state === "recording") {
                mediaRecorderRef.current.stop();
                mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());
                setIsRecording(false);
            }
          };

          return (
            <footer className="bg-[#f0f2f5] p-3 flex items-center gap-3 border-t border-gray-300">
              <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" />
              <button onClick={() => fileInputRef.current?.click()} className="p-2 text-gray-500 hover:text-[#00a884]">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
              </button>
              <div className="flex-grow">
                <input
                  type="text"
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                  placeholder="Type a message..."
                  className="w-full px-4 py-2 bg-white border border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-[#00a884]"
                />
              </div>
              {text ? (
                <button onClick={handleSend} className="p-2 text-white bg-[#00a884] rounded-full hover:bg-[#008a6e]">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                </button>
              ) : (
                <button onMouseDown={startRecording} onMouseUp={stopRecording} onTouchStart={startRecording} onTouchEnd={stopRecording} className={`p-2 text-white rounded-full transition-colors ${isRecording ? 'bg-red-500 animate-pulse' : 'bg-[#00a884] hover:bg-[#008a6e]'}`}>
                   <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-5.93 5.98A5.98 5.98 0 0111 14.93zM6.07 13.02A7.001 7.001 0 003 8H2a8 8 0 1010 7.93v-1.02a6.98 6.98 0 01-5.93-1.98z" clipRule="evenodd" /></svg>
                </button>
              )}
            </footer>
          );
        };

        // --- START OF components/MessageBubble.tsx ---
        const MessageBubble = ({ message, characterProfile, userProfile, onDelete, onEdit }) => {
          const isUser = message.sender === MessageSender.USER;
          const [isEditing, setIsEditing] = useState(false);
          const [editText, setEditText] = useState(message.text);
          const [showDelete, setShowDelete] = useState(false);
          
          const profile = isUser ? userProfile : characterProfile;
          const avatar = isUser ? userProfile.avatar : characterProfile.avatars[characterProfile.activeAvatarIndex];
          
          const handleEditSubmit = () => {
              onEdit(message.id, editText);
              setIsEditing(false);
          }

          const handlePlayAudio = () => {
            if(message.text) {
                playTextAsSpeech(message.text, characterProfile.personality);
            }
          }

          return (
            <div className={`flex items-end gap-2 ${isUser ? 'justify-end' : 'justify-start'}`}>
              {!isUser && (
                <img
                  src={avatar || 'https://picsum.photos/seed/ai/200'}
                  alt={profile.name}
                  className="w-8 h-8 rounded-full object-cover self-start"
                />
              )}
              <div 
                className={`relative group max-w-sm md:max-w-md ${isUser ? 'order-1' : 'order-2'}`}
                onMouseEnter={() => setShowDelete(true)}
                onMouseLeave={() => setShowDelete(false)}
              >
                <div className={`px-4 py-2 rounded-xl shadow ${isUser ? 'bg-[#dcf8c6]' : 'bg-white'}`}>
                  {message.attachment && (
                    <div className="mb-2">
                        {message.attachment.type.startsWith('image/') ? (
                            <img src={`data:${message.attachment.type};base64,${message.attachment.data}`} alt={message.attachment.name} className="rounded-lg max-w-full h-auto" />
                        ) : (
                            <div className="p-2 bg-gray-200 rounded-lg text-sm text-gray-700">
                                File: {message.attachment.name}
                            </div>
                        )}
                    </div>
                  )}

                  {message.audio && (
                     <div className="mb-2">
                        <audio controls src={`data:audio/webm;base64,${message.audio}`} className="w-full"></audio>
                     </div>
                  )}
                  
                  {isEditing ? (
                    <div className="flex flex-col">
                        <textarea 
                            value={editText}
                            onChange={(e) => setEditText(e.target.value)}
                            className="w-full p-2 border rounded"
                            rows={3}
                        />
                        <div className="flex justify-end gap-2 mt-2">
                            <button onClick={() => setIsEditing(false)} className="text-xs text-gray-600">Cancel</button>
                            <button onClick={handleEditSubmit} className="text-xs text-blue-600 font-semibold">Save</button>
                        </div>
                    </div>
                  ) : (
                    <p className="text-gray-800 whitespace-pre-wrap">{message.text}</p>
                  )}

                </div>
                
                <div className={`absolute top-1/2 -translate-y-1/2 flex items-center transition-opacity duration-200 ${showDelete ? 'opacity-100' : 'opacity-0'} ${isUser ? 'left-0 -translate-x-full' : 'right-0 translate-x-full'}`}>
                    <button onClick={() => onDelete(message.id)} className="p-1 text-gray-500 hover:text-red-500 bg-white rounded-full shadow-md m-1">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>
                    </button>
                    {isUser && !isEditing && message.text && (
                         <button onClick={() => setIsEditing(true)} className="p-1 text-gray-500 hover:text-blue-500 bg-white rounded-full shadow-md m-1">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </button>
                    )}
                    {!isUser && message.text && (
                        <button onClick={handlePlayAudio} className="p-1 text-gray-500 hover:text-blue-500 bg-white rounded-full shadow-md m-1">
                             <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                        </button>
                    )}
                </div>

              </div>
               {isUser && (
                <img
                  src={avatar || 'https://picsum.photos/seed/user/200'}
                  alt={profile.name}
                  className="w-8 h-8 rounded-full object-cover order-2 self-start"
                />
              )}
            </div>
          );
        };

        // --- START OF components/MessageList.tsx ---
        const MessageList = ({ messages, character, userProfile, isTyping, onDeleteMessage, onEditMessage }) => {
          const endOfMessagesRef = useRef(null);

          useEffect(() => {
            endOfMessagesRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages, isTyping]);

          return (
            <main className="flex-grow p-4 overflow-y-auto" style={{backgroundImage: "url('https://i.redd.it/qwd83nc4xxf41.jpg')", backgroundSize: 'cover', backgroundPosition: 'center' }}>
              <div className="space-y-4">
                {messages.map((msg) => (
                  <MessageBubble
                    key={msg.id}
                    message={msg}
                    characterProfile={character}
                    userProfile={userProfile}
                    onDelete={onDeleteMessage}
                    onEdit={onEditMessage}
                  />
                ))}
                {isTyping && messages[messages.length-1]?.text === '' && (
                  <div className="flex justify-start">
                     <img src={character.avatars[character.activeAvatarIndex] || 'https://picsum.photos/seed/ai/200'} alt="ai" className="w-8 h-8 rounded-full object-cover mr-2" />
                    <div className="bg-white rounded-lg p-3 max-w-xs shadow">
                      <div className="flex items-center justify-center space-x-1">
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-0"></span>
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-150"></span>
                        <span className="w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-300"></span>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={endOfMessagesRef} />
              </div>
            </main>
          );
        };

        // --- START OF components/ChatHeader.tsx ---
        const ChatHeader = ({ character, onBack, onEditProfile, onEditUser, onClearChat }) => {
          const [menuOpen, setMenuOpen] = useState(false);
          const menuRef = useRef(null);

          useEffect(() => {
            const handleClickOutside = (event) => {
              if (menuRef.current && !menuRef.current.contains(event.target)) {
                setMenuOpen(false);
              }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, []);
          
          return (
            <header className="bg-[#00a884] text-white p-3 flex items-center shadow-md z-10">
              <button onClick={onBack} className="p-2 rounded-full hover:bg-white/20">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <img
                src={character.avatars[character.activeAvatarIndex] || 'https://picsum.photos/seed/ai/200'}
                alt={character.name}
                className="w-10 h-10 rounded-full object-cover ml-2"
              />
              <div className="ml-3">
                <h2 className="font-semibold text-lg">{character.name}</h2>
              </div>
              <div className="ml-auto relative" ref={menuRef}>
                <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                </button>
                {menuOpen && (
                    <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                        <a href="#" onClick={(e) => { e.preventDefault(); onEditUser(); setMenuOpen(false); }} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit Your Profile</a>
                        <a href="#" onClick={(e) => { e.preventDefault(); onEditProfile(); setMenuOpen(false); }} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit Companion</a>
                        <a href="#" onClick={(e) => { e.preventDefault(); onClearChat(); setMenuOpen(false); }} className="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Clear Chat</a>
                    </div>
                )}
              </div>
            </header>
          );
        };

        // --- START OF components/CharacterSetup.tsx ---
        const CharacterSetup = ({ initialCharacter, onSave, onCancel }) => {
          const [character, setCharacter] = useState(initialCharacter);

          const handleFileChange = (e) => {
            if (e.target.files) {
              const files = Array.from(e.target.files);
              files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                  if (event.target && typeof event.target.result === 'string') {
                    setCharacter(prev => ({ ...prev, avatars: [...prev.avatars, event.target.result] }));
                  }
                };
                reader.readAsDataURL(file);
              });
            }
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            if (character.name.trim() === '') {
                alert("Please enter a name for the character.");
                return;
            }
            onSave(character);
          };

          return (
            <form onSubmit={handleSubmit} className="p-2 space-y-4">
              <h2 className="text-xl font-bold text-center text-gray-700">Create Companion</h2>
              <div>
                <label className="block text-sm font-medium text-gray-700">Name</label>
                <input
                  type="text"
                  value={character.name}
                  onChange={(e) => setCharacter({ ...character, name: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[#00a884] focus:border-[#00a884]"
                  placeholder="E.g., Alex"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Relationship</label>
                <select
                  value={character.relationship}
                  onChange={(e) => setCharacter({ ...character, relationship: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[#00a884] focus:border-[#00a884]"
                >
                  {Object.values(Relationship).map(r => <option key={r} value={r}>{r}</option>)}
                </select>
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Behavior</label>
                <select
                  value={character.personality}
                  onChange={(e) => setCharacter({ ...character, personality: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[#00a884] focus:border-[#00a884]"
                >
                  {Object.values(Personality).map(p => <option key={p} value={p}>{p}</option>)}
                </select>
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Custom Behavior (Overrides above)</label>
                 <textarea
                  value={character.customPersonality}
                  onChange={(e) => setCharacter({ ...character, customPersonality: e.target.value })}
                  className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[#00a884] focus:border-[#00a884]"
                  rows={3}
                  placeholder="Describe a custom personality..."
                />
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Profile Pictures</label>
                <input
                    type="file"
                    multiple
                    accept="image/*"
                    onChange={handleFileChange}
                    className="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#e0f2f1] file:text-[#00a884] hover:file:bg-[#b2dfdb]"
                />
                <div className="mt-2 flex flex-wrap gap-2">
                    {character.avatars.map((avatar, index) => (
                        <img
                            key={index}
                            src={avatar}
                            alt={`Avatar ${index + 1}`}
                            className={`w-16 h-16 rounded-lg object-cover cursor-pointer border-2 ${character.activeAvatarIndex === index ? 'border-[#00a884]' : 'border-transparent'}`}
                            onClick={() => setCharacter(prev => ({ ...prev, activeAvatarIndex: index }))}
                        />
                    ))}
                </div>
              </div>
              <div className="flex justify-end space-x-2 pt-4">
                <button type="button" onClick={onCancel} className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#00a884] hover:bg-[#008a6e]">Save</button>
              </div>
            </form>
          );
        };

        // --- START OF components/ChatScreen.tsx ---
        const ChatScreen = ({ character, userProfile, onCharacterUpdate, onBack, onUserProfileUpdate }) => {
          const [messages, setMessages] = useState(character.messages);
          const [isTyping, setIsTyping] = useState(false);
          const [showSettings, setShowSettings] = useState(false);
          const [showUserProfile, setShowUserProfile] = useState(false);

          useEffect(() => {
            onCharacterUpdate({ ...character, messages });
          }, [messages]);

          const handleSend = useCallback(async (text, attachment, audio) => {
            const userMessage = {
              id: `msg_${Date.now()}`,
              sender: MessageSender.USER,
              text: text,
              timestamp: Date.now(),
              attachment,
              audio
            };

            setMessages(prev => [...prev, userMessage]);
            setIsTyping(true);

            const aiMessageId = `msg_${Date.now() + 1}`;
            const streamingMessage = {
              id: aiMessageId,
              sender: MessageSender.AI,
              text: '',
              timestamp: Date.now(),
            };
            setMessages(prev => [...prev, streamingMessage]);

            const updateStreamingMessage = (chunk) => {
                setMessages(prev =>
                    prev.map(msg =>
                        msg.id === aiMessageId ? { ...msg, text: msg.text + chunk } : msg
                    )
                );
            };

            await generateChatResponseStream({ ...character, messages: [...messages, userMessage] }, userMessage, updateStreamingMessage);
            
            setIsTyping(false);
          }, [character, messages]);

          const handleDeleteMessage = (messageId) => {
            setMessages(prev => prev.filter(m => m.id !== messageId));
          };
          
          const handleEditMessage = (messageId, newText) => {
            setMessages(prev => prev.map(m => m.id === messageId ? { ...m, text: newText } : m));
          }
          
          const handleClearChat = () => {
              if (window.confirm("Are you sure you want to delete all messages in this chat?")) {
                setMessages([]);
                setShowSettings(false);
              }
          }
          
          const handleSaveSettings = (updatedCharacter) => {
            onCharacterUpdate({...updatedCharacter, messages });
            setShowSettings(false);
          }

          return (
            <div className="flex flex-col h-full w-full bg-[#EFEAE2]">
              <ChatHeader 
                character={character} 
                onBack={onBack} 
                onEditProfile={() => setShowSettings(true)}
                onEditUser={() => setShowUserProfile(true)}
                onClearChat={handleClearChat}
              />
              <MessageList 
                messages={messages} 
                character={character} 
                userProfile={userProfile} 
                isTyping={isTyping} 
                onDeleteMessage={handleDeleteMessage}
                onEditMessage={handleEditMessage}
              />
              <MessageInput onSend={handleSend} />

              {showSettings && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <CharacterSetup
                            initialCharacter={character}
                            onSave={handleSaveSettings}
                            onCancel={() => setShowSettings(false)}
                        />
                    </div>
                </div>
              )}

              {showUserProfile && (
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <UserProfileSetup
                            userProfile={userProfile}
                            onSave={(profile) => {
                                onUserProfileUpdate(profile);
                                setShowUserProfile(false);
                            }}
                            onCancel={() => setShowUserProfile(false)}
                        />
                    </div>
                </div>
              )}

            </div>
          );
        };

        // --- START OF components/CharacterList.tsx ---
        const CharacterList = ({ characters, onSelectCharacter, setCharacters }) => {
          const [isCreating, setIsCreating] = useState(false);

          const handleSaveCharacter = (character) => {
            setCharacters(prev => [...prev, character]);
            setIsCreating(false);
          };
          
          const handleDeleteCharacter = (e, id) => {
            e.stopPropagation();
            if(window.confirm('Are you sure you want to delete this character and all its chats?')) {
                setCharacters(prev => prev.filter(c => c.id !== id));
            }
          }

          const defaultCharacter = {
            id: `char_${Date.now()}`,
            name: '',
            relationship: Relationship.GIRLFRIEND,
            personality: Personality.CARING,
            customPersonality: '',
            avatars: [],
            activeAvatarIndex: 0,
            messages: [],
          };

          return (
            <div className="flex flex-col h-full bg-[#00a884]">
              <header className="bg-[#00a884] text-white p-4 pt-8">
                <h1 className="text-2xl font-bold">RealChat AI</h1>
                <p className="text-sm opacity-90">Your AI Companions</p>
              </header>
              <main className="flex-grow bg-white rounded-t-2xl p-4 overflow-y-auto">
                {isCreating ? (
                  <CharacterSetup
                    initialCharacter={defaultCharacter}
                    onSave={handleSaveCharacter}
                    onCancel={() => setIsCreating(false)}
                  />
                ) : (
                  <>
                    <div className="space-y-3">
                      {characters.length === 0 && (
                        <div className="text-center text-gray-500 py-10">
                            <p>No companions yet.</p>
                            <p>Click "Create New Companion" to start.</p>
                        </div>
                      )}
                      {characters.map(char => (
                        <div key={char.id} onClick={() => onSelectCharacter(char.id)} className="flex items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors duration-200">
                          <img src={char.avatars[char.activeAvatarIndex] || 'https://picsum.photos/seed/user/200'} alt={char.name} className="w-12 h-12 rounded-full object-cover mr-4" />
                          <div className="flex-grow">
                            <h2 className="font-semibold text-gray-800">{char.name}</h2>
                            <p className="text-sm text-gray-500 truncate">{char.messages[char.messages.length - 1]?.text || 'No messages yet'}</p>
                          </div>
                           <button onClick={(e) => handleDeleteCharacter(e, char.id)} className="ml-2 text-red-500 hover:text-red-700 p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-red-400">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>
                           </button>
                        </div>
                      ))}
                    </div>
                    <div className="mt-6">
                      <button onClick={() => setIsCreating(true)} className="w-full bg-[#00a884] text-white py-3 px-4 rounded-lg font-semibold hover:bg-[#008a6e] transition-colors duration-200">
                        Create New Companion
                      </button>
                    </div>
                  </>
                )}
              </main>
            </div>
          );
        };


        // --- START OF App.tsx ---
        const App = () => {
          const [characters, setCharacters] = useState([]);
          const [activeCharacterId, setActiveCharacterId] = useState(null);
          const [userProfile, setUserProfile] = useState({
            id: 'user',
            name: 'You',
            avatar: '',
          });

          useEffect(() => {
            try {
              const savedCharacters = localStorage.getItem('characters');
              if (savedCharacters) {
                setCharacters(JSON.parse(savedCharacters));
              }
              const savedUserProfile = localStorage.getItem('userProfile');
              if(savedUserProfile) {
                setUserProfile(JSON.parse(savedUserProfile));
              }
            } catch (error) {
              console.error("Failed to load data from localStorage", error);
            }
          }, []);

          useEffect(() => {
            try {
              localStorage.setItem('characters', JSON.stringify(characters));
            } catch (error) {
              console.error("Failed to save characters to localStorage", error);
            }
          }, [characters]);

          useEffect(() => {
            try {
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
            } catch (error) {
                console.error("Failed to save user profile to localStorage", error);
            }
          }, [userProfile]);

          const handleSelectCharacter = (id) => {
            setActiveCharacterId(id);
          };

          const handleBackToList = () => {
            setActiveCharacterId(null);
          };

          const activeCharacter = characters.find(c => c.id === activeCharacterId);

          return (
            <div className="h-screen w-screen bg-gray-100 flex items-center justify-center font-sans">
              <div className="w-full max-w-md h-full sm:h-[95vh] sm:max-h-[800px] bg-[#f0f2f5] shadow-2xl rounded-lg flex flex-col">
                {activeCharacter ? (
                  <ChatScreen
                    character={activeCharacter}
                    userProfile={userProfile}
                    onCharacterUpdate={(updatedCharacter) => {
                      setCharacters(chars => chars.map(c => c.id === updatedCharacter.id ? updatedCharacter : c));
                    }}
                    onBack={handleBackToList}
                    onUserProfileUpdate={setUserProfile}
                  />
                ) : (
                  <CharacterList
                    characters={characters}
                    onSelectCharacter={handleSelectCharacter}
                    setCharacters={setCharacters}
                  />
                )}
              </div>
            </div>
          );
        };

        // --- START OF index.tsx ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
